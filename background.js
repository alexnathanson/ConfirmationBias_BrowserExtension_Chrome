/*CHROME VERSION
Changes between this and Firefox version
browser namespace changed to chrome ex. chrome.storage.local...
chrome.storage.local requires a function and .then doesn't work.
the applications key in the manifest file was removed
*/

var globalURL;
var oldURL = "genericwebsite";
var slider;
var check;

var opposing = {};
var mediaStor = {};

//load settings

function onGot(item) {

//added 12/23
  if (!item.userSettings) {
    userSettings = {
      check: 1,
      slide: 50
      }
    chrome.storage.local.set({userSettings});
  } else {

  slider = item.userSettings.slide;
  check = item.userSettings.check;
    }
  //console.log("slide: " + slider);
  //console.log("check: " + check);
}

function settings(){
  // load user settings
  var getSettings = "";
  chrome.storage.local.get("userSettings", function(results){
  getSettings = results;
  onGot(getSettings);
  });
  }

// Load existent stats with the storage API.
var gettingStoredStats = "";
chrome.storage.local.get("hostNavigationStats", function(results){
  gettingStoredStats = results;
});

settings();

gettingStoredStatsThen(gettingStoredStats);

function gettingStoredStatsThen(results) {

  

  // Initialize the saved stats if not yet initialized.
  if (!results.hostNavigationStats) {
    results = {
      hostNavigationStats: {}
    };
  }

  if (!opposing.opposingNavigationStats){
    opposing = {
      opposingNavigationStats: {}
    };
  }

  console.log("Confirmation Bias Extension BEGIN");

  const {opposingNavigationStats} = opposing;
  const {hostNavigationStats} = results;

  // Monitor completed navigation events and update
  // stats accordingly.
  chrome.webNavigation.onCompleted.addListener(evt => {
    settings();

    if (check == true){

      // Filter out any sub-frame related navigation event
      if (evt.frameId !== 0) {
        return;
      }

      const url = new URL(evt.url);

      //check if url is considered a news site
      if (checkMedia(url) == 1){
        

        //make notification
        //checks to make sure it wont be redundant
        globalURL = oppositionMedia(url);
        var thisURL = url.toString();

        if (thisURL.includes(oldURL) == false){

          //moved into this if statement for version 0.1.1
          hostNavigationStats[url.hostname] = hostNavigationStats[url.hostname] || 0;
          hostNavigationStats[url.hostname]++;

          notify(globalURL, polX);
          oldURL = globalURL;

          opposingNavigationStats[globalURL] = opposingNavigationStats[globalURL] || 0;
          opposingNavigationStats[globalURL]++;
    
        }

        // Persist the updated stats.
        chrome.storage.local.set(results);
        chrome.storage.local.set(opposing);

      };
    }
  }, {
    url: [{schemes: ["http", "https"]}]});
};

//clickable notification link
chrome.notifications.onClicked.addListener(()=> {
  notificationClick(globalURL);
  });
  

function notificationClick(link){
    //go to url
    //console.log("clicked: " + link);
    chrome.tabs.create({url: "http://www." + link});
  }

/*
Log that we received the message.
Then display a notification. The notification contains the URL,
which we read from the message.
*/

function notify(message, polX) {
  //console.log("background script received message!");
  var title = chrome.i18n.getMessage("notificationTitle");
  var content = chrome.i18n.getMessage("notificationContent", message);
  var politics;

  if (polX > 0){
    politics = "more left wing";
  } else if (polX = 0){
    politics = "politically similar";
  } else {
    politics = "more right wing";
  }


  chrome.notifications.create({
    "type": "basic",
    "iconUrl": chrome.extension.getURL("icons/confirmationicon3b-48.png"),
    "title": title,
    "message": `${content} \n \n It's ${politics} and trusted differently.`
  });
}

function checkMedia(message){
  //console.log("checking media: " + message);
  var isNews = 0;
  var theMessage = message.toString();

  // get the media array
  var mediaSources = mediaList();

  //get length of list of media sources
  for (i = 0; i< mediaSources.length; i++){
    var checkIt = mediaSources[i][0];
    if (theMessage.includes(checkIt) == true){
      return 1;
    };
  };
}

/*determine and retrieve media in opposition to the users behaviour.
Determines distance based on the politics (X) and 
the subjective trustworthyness (Y) of a given publication.
Does not recommend social media sites, but does factor it into calculations.
*/
function oppositionMedia(message){
  var mediaSources = mediaList();
  var theMessage = message.toString();
  var X1;
  var Y1;
  var distance;
  // must be scale to account for hypotenues
  //console.log(slider);
  var min = ((.3 + (slider * .0025))* 2.236);  //minimum media difference to be considered.
  var max = ((.5 + (slider * .005))* 2.236);

  var f = 0; //index for possibles

//  check min scaling
//console.log("slider: " + slider + ", min: " + min + ", max: " + max);

  //get X and Y of message
  for (i = 0; i< mediaSources.length; i++){
    var checkIt = mediaSources[i][0];
    if (theMessage.includes(checkIt) == true){
      X1 = mediaSources[i][1];
      Y1 = mediaSources[i][2];
      break;
    };
  };

  //got through array and run equation, pull out indexes of possible outputs
  var possibles = new Array();

  for (i = 0; i< mediaSources.length; i++){
    var X2 = mediaSources[i][1];
    var Y2 = mediaSources[i][2];

    distance = Math.sqrt(Math.pow((X1 - X2), 2) + Math.pow((Y1 - Y2), 2));
    //console.log("distance: " + distance);
    if (distance >= min && distance <= max){
      if (mediaSources[i][3] <= 2){ //check that it isn't a social media or extremist site
        possibles[f] = i; //add new possibility to list
        f++;
      }
    }
  }

  //randomly select one of the possible outputs
  var pickIt = Math.trunc(Math.random() * possibles.length); //check that it isn't short 1

  getDistance(X1, Y1, mediaSources[possibles[pickIt]][1], mediaSources[possibles[pickIt]][2]);
  //returns a link to suggest
  return mediaSources[possibles[pickIt]][0];
}

var polX;
var trustY;

function getDistance(X1, Y1, X2, Y2){
  polX = (X1 + 1) - (X2 + 1);
  trustY = Y1 - Y2;
}
